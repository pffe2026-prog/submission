name: CI Exam Java

on:
  push:
    branches:
      - "student-*"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submissions repo
        uses: actions/checkout@v4

      - name: Locate metadata file
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          # Use metadata modified by the current push commit to avoid grading an older submission.
          FILE=$(git show --name-only --pretty='' "${GITHUB_SHA}" | grep -E '^solutions/.+/metadata\.json$' | head -n 1 || true)

          # Fallback: most recently modified metadata in the working tree.
          if [ -z "$FILE" ]; then
            FILE=$(find solutions -type f -name metadata.json -printf '%T@ %p\n' | sort -nr | head -n 1 | cut -d' ' -f2- || true)
          fi

          if [ -z "$FILE" ]; then
            echo "metadata.json introuvable dans solutions/"
            exit 1
          fi
          echo "Metadata selectionnee: $FILE"
          echo "meta_file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Show metadata
        run: cat "${{ steps.meta.outputs.meta_file }}"

      - name: Parse metadata
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          META="${{ steps.meta.outputs.meta_file }}"
          TESTS_REPO=$(jq -r '.tests_repo // empty' "$META")
          TESTS_REF=$(jq -r '.tests_ref // empty' "$META")
          ENTRY_FILE=$(jq -r '.entry_file // empty' "$META")
          SOUMISSION_ID=$(jq -r '.soumission_id // empty' "$META")
          BASE_DIR=$(dirname "$META")

          if [ -z "$TESTS_REPO" ] || [ -z "$TESTS_REF" ] || [ -z "$ENTRY_FILE" ] || [ -z "$SOUMISSION_ID" ]; then
            echo "metadata.json incomplet."
            exit 1
          fi

          echo "tests_repo=$TESTS_REPO" >> "$GITHUB_OUTPUT"
          echo "tests_ref=$TESTS_REF" >> "$GITHUB_OUTPUT"
          echo "entry_file=$ENTRY_FILE" >> "$GITHUB_OUTPUT"
          echo "soumission_id=$SOUMISSION_ID" >> "$GITHUB_OUTPUT"
          echo "base_dir=$BASE_DIR" >> "$GITHUB_OUTPUT"

      - name: Checkout tests repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse.outputs.tests_repo }}
          ref: ${{ steps.parse.outputs.tests_ref }}
          path: tests

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Prepare project
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p work
          cp -r tests/* work/
          mkdir -p work/src
          cp "${{ steps.parse.outputs.base_dir }}/${{ steps.parse.outputs.entry_file }}" work/src/Main.java

      - name: Run tests (Maven or Gradle)
        working-directory: work
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "pom.xml" ]; then
            mvn -q -B clean test
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            chmod +x gradlew || true
            ./gradlew test
          else
            echo "No Maven/Gradle config found in tests repo."
            exit 1
          fi

      - name: Post result to webhook
        if: always()
        shell: bash
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
          SOUMISSION_ID: ${{ steps.parse.outputs.soumission_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          set -euo pipefail
          if [ -z "${WEBHOOK_URL:-}" ] || [ -z "${WEBHOOK_TOKEN:-}" ]; then
            echo "Secrets webhook manquants (WEBHOOK_URL / WEBHOOK_TOKEN)."
            exit 1
          fi
          if [ -z "${SOUMISSION_ID:-}" ]; then
            echo "soumission_id manquant, webhook non envoye."
            exit 1
          fi

          if [ "$JOB_STATUS" = "success" ]; then
            NOTE="20.00"
            FEEDBACK="Tests reussis"
            STATUT="CORRIGE"
          else
            NOTE="0.00"
            FEEDBACK="Tests echoues"
            STATUT="ECHEC"
          fi

          PAYLOAD=$(printf '{"soumission": %s, "note": "%s", "feedback": "%s", "statut_soumission": "%s"}' \
            "$SOUMISSION_ID" "$NOTE" "$FEEDBACK" "$STATUT")

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-API-TOKEN: $WEBHOOK_TOKEN" \
            -d "$PAYLOAD")
          cat response.json || true

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Webhook en echec HTTP=$HTTP_CODE"
            exit 1
          fi
